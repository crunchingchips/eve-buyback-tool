<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>EVE Buyback - ESI Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-8 font-sans">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl font-black text-yellow-500 mb-6 uppercase tracking-tighter">EVE Market Direct API</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <textarea id="inventory" class="w-full h-96 bg-gray-800 border border-gray-700 p-4 font-mono text-sm rounded-lg focus:ring-2 focus:ring-yellow-600 outline-none text-green-400" placeholder="Wklej inwentarz..."></textarea>
                <button onclick="processInventory()" id="mainBtn" class="w-full mt-4 bg-yellow-600 hover:bg-yellow-500 text-black font-black py-4 rounded-lg uppercase transition-all">
                    Oblicz Wycenę (Live ESI)
                </button>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 shadow-2xl h-fit">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Podsumowanie rynkowe</h2>
                <div id="total" class="text-3xl font-black mb-2">0 <span class="text-sm text-gray-600">ISK</span></div>
                <div id="net" class="text-xl font-bold text-green-500 border-t border-gray-700 pt-2">Netto: 0 ISK</div>
                <div id="log" class="mt-6 text-[10px] font-mono text-blue-400 h-32 overflow-y-auto bg-black p-2 rounded">Czekam na dane...</div>
            </div>
        </div>
    </div>

    <script>
        const TAX = 0.10;

        async function processInventory() {
            const log = (msg) => document.getElementById('log').innerHTML += `> ${msg}<br>`;
            const input = document.getElementById('inventory').value;
            const lines = input.split('\n').filter(l => l.trim() !== "");
            
            const itemsMap = {};
            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length >= 2) {
                    const name = parts[0].trim();
                    const qty = parseInt(parts[parts.length - 1].replace(/\D/g, '')) || 0;
                    itemsMap[name] = (itemsMap[name] || 0) + qty;
                }
            });

            const names = Object.keys(itemsMap);
            log(`Wysłano ${names.length} nazw do ESI...`);

            try {
                // 1. Zamiana NAZW na ID
                const idRes = await fetch('https://esi.evetech.net/latest/universe/ids/?datasource=tranquility&language=en', {
                    method: 'POST',
                    body: JSON.stringify(names)
                });
                const idData = await idRes.json();
                const inventoryIds = idData.inventory || [];

                // 2. Pobranie CEN dla tych ID
                log("Pobieranie aktualnych cen...");
                const priceRes = await fetch('https://esi.evetech.net/latest/markets/prices/');
                const prices = await priceRes.json();
                const priceLookup = {};
                prices.forEach(p => priceLookup[p.type_id] = p.adjusted_price);

                // 3. Obliczenia
                let total = 0;
                inventoryIds.forEach(item => {
                    const qty = itemsMap[item.name];
                    const price = priceLookup[item.id] || 0;
                    total += price * qty;
                });

                document.getElementById('total').innerHTML = `${Math.floor(total).toLocaleString()} <span class="text-sm text-gray-600">ISK</span>`;
                document.getElementById('net').innerText = `Netto: ${Math.floor(total * (1 - TAX)).toLocaleString()} ISK`;
                log("Gotowe!");

            } catch (err) {
                log("BŁĄD ESI: " + err.message);
            }
        }
    </script>
</body>
</html>
