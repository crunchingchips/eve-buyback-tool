<script>
    async function runProcessor() {
        console.log("=== START PROCESORA ===");
        
        const btn = document.getElementById('calcBtn');
        const table = document.getElementById('itemTable');
        const finalNet = document.getElementById('finalNet');
        const rawInput = document.getElementById('invInput').value.trim();

        console.log("[KROK 1] Surowy tekst z pola (długość):", rawInput.length);

        if (!rawInput) {
            console.log("[!] Puste pole, przerywam.");
            return;
        }

        btn.disabled = true;
        btn.innerText = "PRZETWARZANIE...";
        table.innerHTML = "<tr><td colspan='4' class='p-10 text-center text-yellow-500'>Łączenie z ESI...</td></tr>";

        try {
            const lines = rawInput.split('\n').filter(l => l.trim() !== "");
            console.log(`[KROK 2] Znaleziono linii tekstu: ${lines.length}`, lines);
            
            const inventoryMap = {};

            // Parser
            lines.forEach(line => {
                let name = "";
                let qty = 1;
                if (line.includes('\t')) {
                    const parts = line.split('\t');
                    name = parts[0].trim();
                    qty = parseInt(parts[1].replace(/\D/g, '')) || 1; 
                } else {
                    const match = line.trim().match(/^(.*?)\s+([\d\s]+)$/);
                    if (match) {
                        name = match[1].trim();
                        qty = parseInt(match[2].replace(/\D/g, '')) || 1;
                    } else {
                        name = line.trim();
                    }
                }
                if (name) inventoryMap[name] = (inventoryMap[name] || 0) + qty;
            });

            console.log("[KROK 3] Sparsowana mapa inwentarza (Przedmioty + Ilość):", inventoryMap);

            const uniqueNames = Object.keys(inventoryMap);
            console.log("[KROK 4] Czyste nazwy wysyłane do ESI (POST /universe/ids/):", uniqueNames);

            // Pobieranie ID
            console.log("[KROK 5] Oczekuję na odpowiedź ESI Universe...");
            const idRes = await fetch('https://esi.evetech.net/latest/universe/ids/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(uniqueNames)
            });
            
            if (!idRes.ok) throw new Error(`Błąd ESI (Universe): ${idRes.status}`);
            const idData = await idRes.json();
            
            console.log("[KROK 6] Pełna odpowiedź z ESI (zobacz co jest w środku!):", idData);
            
            const foundItems = idData.inventory_types || [];
            console.log(`[KROK 7] Rozpoznane przedmioty (inventory_types): ${foundItems.length}`, foundItems);

            if (foundItems.length === 0) {
                console.warn("[UWAGA] ESI nie zwróciło żadnych 'inventory_types'!");
                throw new Error("ESI nie rozpoznało żadnej nazwy. Zły format tekstu.");
            }

            // Pobieranie Cen
            console.log("[KROK 8] Pobieram cennik rynkowy...");
            const priceRes = await fetch('https://esi.evetech.net/latest/markets/prices/');
            if (!priceRes.ok) throw new Error(`Błąd ESI (Prices): ${priceRes.status}`);
            const priceData = await priceRes.json();
            
            console.log(`[KROK 9] Pomyślnie pobrano cen dla ${priceData.length} przedmiotów z rynku.`);
            
            const prices = {};
            priceData.forEach(p => prices[p.type_id] = p.adjusted_price || 0);

            // Generowanie Tabeli
            table.innerHTML = "";
            let totalValue = 0;

            foundItems.forEach(item => {
                const qty = inventoryMap[item.name];
                const price = prices[item.id] || 0;
                const subtotal = price * qty;
                totalValue += subtotal;

                console.log(`[KROK 10] Renderuję: ${item.name} | Ilość: ${qty} | Cena sztuki: ${price}`);

                table.innerHTML += `
                    <tr class="hover:bg-white/5">
                        <td class="px-4 py-3 flex items-center gap-3">
                            <img src="https://images.evetech.net/types/${item.id}/icon?size=32" class="w-6 h-6 rounded">
                            <span>${item.name}</span>
                        </td>
                        <td class="px-4 py-3 text-right text-yellow-600">${qty.toLocaleString()}</td>
                        <td class="px-4 py-3 text-right text-gray-500">${Math.floor(price).toLocaleString()}</td>
                        <td class="px-4 py-3 text-right font-bold text-white">${Math.floor(subtotal).toLocaleString()} ISK</td>
                    </tr>`;
            });

            const net = Math.floor(totalValue * 0.9);
            finalNet.innerText = net.toLocaleString() + " ISK";
            console.log(`[KROK 11] Sukces! Wartość netto wyliczona: ${net} ISK`);

        } catch (err) {
            console.error("[KRYTYCZNY BŁĄD]:", err);
            table.innerHTML = `<tr><td colspan='4' class='p-10 text-center text-red-500 uppercase'>BŁĄD: ${err.message}</td></tr>`;
        } finally {
            btn.disabled = false;
            btn.innerText = "Oblicz Wycenę";
            console.log("=== KONIEC PROCESORA ===");
        }
    }
</script>
